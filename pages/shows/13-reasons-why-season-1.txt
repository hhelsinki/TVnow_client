import Footer from "@/parts/footer";
import Header from "@/parts/header";
import axios from "axios";
import Head from "next/head";
import { useRouter } from "next/navigation";
import { useEffect, useState } from "react";
import styled from './show.module.scss';
import Cookies from "js-cookie";
import { ContentEp, ContentHeadline, ContentRelated, ContentSs } from "@/parts/seo/content_seo";
import { scrollInvertXep, scrollInvertXrelated, scrollInvertXss, scrollXep, scrollXrelated, scrollXss } from "@/functions/scrollX";
import { query_path } from "@/functions/query";

interface State {
    title: string,
    season: number,
    poster_mb: string,
    poster_tb: string,
    poster_pc: string,
    story: string,
    genre: string,
    year: number,
    starring: string,
    country: string
}

const ThirteenReasonsWhySSI = () => {
    const router = useRouter();
    const query = router.pathname.replace(query_path, '');
    const [values, setValues] = useState<State>({
        title: '',
        season: 1,
        poster_mb: '',
        poster_tb: '',
        poster_pc: '',
        story: '',
        genre: '',
        year: 2020,
        starring: '',
        country: ''
    });
    const [allEPs, setAllEPs] = useState<any>([]);
    const [allSSs, setAllSSs] = useState<any>([]);
    const [related, setRelated] = useState<any>([]);

    const loadContents = async () => {
        await axios.get(`http://localhost:3001${router.pathname}`)
            .then((res) => {
                console.log(res.data)
                const newAllEPs: any = [];
                const newAllSSs: any = [];
                const newRelated: any = [];

                setValues({
                    ...values,
                    title: res.data.info.title,
                    season: res.data.info.season,
                    poster_mb: 'http://localhost:3001/' + res.data.info.poster_mb,
                    poster_tb: 'http://localhost:3001/' + res.data.info.poster_pc,
                    poster_pc: 'http://localhost:3001/' + res.data.info.poster_pc,
                    story: res.data.info.story, genre:
                        res.data.info.genre,
                    year: res.data.info.year,
                    starring: res.data.info.starring,
                    country: res.data.info.country,
                });

                res.data.allEPs.forEach((item: any, index: number) => newAllEPs.push(item));
                setAllEPs(newAllEPs);
                res.data.allSeasons.forEach((item: any, index: number) => newAllSSs.push(item));
                setAllSSs(newAllSSs);
                res.data.related.forEach((item: any, index: number) => newRelated.push(item));
                setRelated(newRelated);
            })
            .catch((err) => { console.log(err) })
    }
    const handleLogin = () => {
        //if login has cookie
        //true- redirect to content_?
        //false - login popup
    }

    useEffect(() => {
        loadContents();

        /*let loginToken: any = Cookies.get('TVnow_Login_Token');
        switch (loginToken) {
            case null:
            case undefined:
            case false:
                window.location.href = '/';
                break;
            default:
                break;
        }*/


        Cookies.set('TVnow oldPath', window.location.pathname, { sameSite: 'strict' });
    }, []);

    return (
        <>
            <Head>
                <title>{`TVnow: ${values.title}`}</title>
                <meta name="description" content={`Watch ${values.title}`}/>
            </Head>
            <Header />
            <main className="main scroll-y">
                <article data-name='show__headline'>
                    <ContentHeadline
                        poster_mb={values.poster_mb}
                        poster_tb={values.poster_tb}
                        poster_pc={values.poster_pc}
                        title={values.title.toLocaleUpperCase()}
                        storySubstringMb={values.story.substring(0, 100)}
                        storyLength={values.story.length}
                        storySubstringTb={values.story.substring(0, 200)}
                        storyPc={values.story}
                    />
                </article>
                <div className="div-content-long div-center padd-default">
                    <ContentEp
                        scrollXep={scrollXep}
                        scrollInvertXep={scrollInvertXep}
                        allEPs={allEPs.map((el: any, i: number) => {
                            return <div key={i} className="rel dp-inline-block">
                                <a href={el.url}><div className={styled['show__hr-overlay']}>
                                    <div className={styled['show__hr-txt']}>{el.ep}</div>
                                </div>
                                    <img src={"http://localhost:3001" + el.img} />
                                    <span className="abs">{el.ep}</span></a>
                            </div>
                        })}
                    />
                    <ContentSs
                        scrollXss={scrollXss}
                        scrollInvertXss={scrollInvertXss}
                        allSSs={allSSs.map((el: any, i: number) => {
                            return <div key={i} className="rel dp-inline-block">
                                <a href={el.url}><div className={styled['show__hr-overlay']}>
                                    <div className={styled['show__hr-txt']}>{el.season}</div>
                                </div>
                                    <img src={"http://localhost:3001" + el.img} />
                                    <span className="abs">{el.season}</span></a>
                            </div>
                        })}
                    />
                    <ContentRelated
                        scrollXrelated={scrollXrelated}
                        scrollInvertXrelated={scrollInvertXrelated}
                        related={related.map((el: any, i: number) => {
                            return <div key={i} className="rel dp-inline-block">
                                <a href={el.url}><div className={styled['show__hr-overlay']}>
                                    <div className={styled['show__hr-txt']}>{el.title}</div>
                                </div>
                                    <img src={"http://localhost:3001" + el.img} />
                                    <span className="abs mobile">{el.title.substring(0,10)}{el.title.length >= 10 && '...'}</span>
                                    <span className="abs tablet">{el.title.substring(0,20)}{el.title.length >= 20 && '...'}</span>
                                    <span className="abs pc">{el.title.substring(0,25)}{el.title.length >= 25 && '...'}</span></a>
                            </div>
                        })}
                    />
                    <a href={`../contents?n=${query}`}><button>Go to watch</button></a>
                </div>
                <div className="div-ghost"></div>
            </main >
            <Footer />
        </>
    );
}

export default ThirteenReasonsWhySSI;